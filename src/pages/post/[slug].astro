---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

export async function getStaticPaths() {
  const { data: posts } = await supabase.from('posts').select('slug');
  return posts?.map(post => ({ params: { slug: post.slug } })) || [];
}

const { slug } = Astro.params;

let post;
try {
  const { data, error } = await supabase
    .from('posts')
    .select('*')
    .eq('slug', slug)
    .single();

  if (error) throw error;
  post = data;
} catch (e) {
  console.error('Error fetching post:', e);
  return Astro.redirect('/404');
}

if (!post) return Astro.redirect('/404');
---

<Layout title={`${post.title} | Blog Limpiezas Torrenueva`}>
  <main class="page-hero" style="min-height: 60vh; background-image: none; background-color: #f8fafc;">
    <!-- Hero Image for Post -->
    <div style="height: 400px; position: relative; overflow: hidden;">
        <img src={post.image_url || '/blog-placeholder.jpg'} alt={post.title} style="width: 100%; height: 100%; object-fit: cover;">
        <div class="page-hero__overlay"></div>
        <div class="container page-hero__content" style="position: absolute; bottom: 0; left: 0; padding: 4rem 2rem;">
            <span class="section-tag" style="background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 4px; display: inline-block; margin-bottom: 1rem;">{post.tag || 'Blog'}</span>
            <h1 class="page-hero__title" style="font-size: 3rem;">{post.title}</h1>
            <p style="color: white; opacity: 0.9; margin-top: 1rem;">Publicado el {new Date(post.created_at).toLocaleDateString()}</p>
        </div>
    </div>

    <section class="section-padding">
        <div class="container">
            <article style="max-width: 800px; margin: 0 auto; background: white; padding: 4rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                <div style="font-size: 1.1rem; line-height: 1.8; color: #334155;">
                    {post.content}
                </div>
                
                <div style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid #e2e8f0;">
                    <a href="/blog" class="button button--primary">‚Üê Volver al Blog</a>
                </div>
            </article>
        </div>
    </section>
  </main>
</Layout>
