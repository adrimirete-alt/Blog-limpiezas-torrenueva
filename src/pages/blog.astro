---

import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

let posts = [];
try {
    const { data, error } = await supabase
        .from('posts')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (error) {
        console.error('Error fetching posts:', error);
    } else {
        posts = data;
    }
} catch (e) {
    console.error('Supabase connection failed:', e);
}

---
<Layout title="Blog | Limpiezas Torrenueva">
    <main>
        <!-- Page Hero -->
        <section class="page-hero">
            <div class="page-hero__bg">
                <img src="https://images.unsplash.com/photo-1455390582262-044cdead277a?q=80&w=2072&auto=format&fit=crop"
                    alt="Blog de Limpieza" class="page-hero__img">
            </div>
            <div class="page-hero__overlay"></div>
            <div class="container page-hero__content">
                <h1 class="page-hero__title">Nuestro Blog</h1>
                <p class="page-hero__subtitle">Noticias, consejos y actualizaciones sobre limpieza y mantenimiento.</p>
            </div>
        </section>

        <section class="section-padding">
            <div class="container">
                <div class="services__grid"> <!-- Reusing services grid for blog layout consistency -->
                    {posts && posts.length > 0 ? (
                        posts.map((post) => (
                            <article class="service-card">
                                <div class="service-card__image">
                                    <img src={post.image_url || '/blog-placeholder.jpg'} alt={post.title} style="width: 100%; height: 260px; object-fit: cover;">
                                </div>
                                <div class="service-card__content">
                                    <span class="section-tag">{post.tag || 'General'}</span>
                                    <h3 class="service-card__title">{post.title}</h3>
                                    <p class="service-card__desc">{post.description}</p>
                                    <a href={`/post/${post.slug}`} class="link-arrow">Leer más <span>→</span></a>
                                </div>
                            </article>
                        ))
                    ) : (
                        <p style="grid-column: 1 / -1; text-align: center; color: #64748b;">No hay artículos publicados todavía.</p>
                    )}
                </div>
            </div>
        </section>
    </main>
</Layout>
